---
title: "OpenStreetMap API"
author: "Mauricio Eduardo Landim"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
---

# Introdução

O intuito deste texto é explorar a variedade de dados que podemos requisitar a partir da API do OpenStreetMap.

# Esquema do Banco de Dados

Nesta primeira seção gostaria de expor o esquema do banco de dados do OpenStreetMaps e seus respectivos elementos.
Podemos ter um entendimento melhor do esquema do banco de dados através do link (https://wiki.openstreetmap.org/wiki/Openstreetmap-website/Database_schema) e pela imagem (https://wiki.openstreetmap.org/w/images/1/10/ERD_of_OSM_DB.svg).
O OpenStreetMaps tem 3 tipos de dados primitivos, que seriam os nodes, ways e relations. Um melhor detalhamento sobre estes elementos pode ser visto no link (https://wiki.openstreetmap.org/wiki/Elements).
Além disso, existem tabelas que são relacionadas as experiencias do usuário e suas atividades dentro da plataforma do OSM, assim como a users, changesets, gpx, notes, diary_entries.
As demais tabelas dizem respeito as atividades de back-end e funções de desenvolvedores.

Dentro do esquema temos tabelas pai e tabelas filhos, estas segundas que desempenham funções suplementares as funções da tabela pai.

Tabelas principais:

1. users (https://wiki.openstreetmap.org/wiki/User)
  + user_tokens
  + user_roles
  + user_blocks
  + friends
  + messages
  + reports
  + issues
  + issue_comments
2. changesets (https://wiki.openstreetmap.org/wiki/Changeset)
  + changesets_subscribers
  + changesets_comments
  + changesets_tags
3. nodes (https://wiki.openstreetmap.org/wiki/Node)
  + node_tags
  + current_nodes
  + current_node_tags
4. ways (https://wiki.openstreetmap.org/wiki/Way)
  + way_tags
  + way_nodes
  + current_ways
  + current_way_nodes
  + current_way_tags
5. relations (https://wiki.openstreetmap.org/wiki/Relation)
  + relation_tags
  + relation_members
  + current_relations
  + current_relation_members
  + current_relation_tag
6. redactions (https://wiki.openstreetmap.org/wiki/Redaction_bot_progress_map)
7. gpx_files
  + gpx_file_tags
  + gps_points
8. notes
  + note_comments
9. diary_entries
  + diary_comments
  + diary_entry_subscriptions
  + languages

Tabelas do OAuth:

* client_applications
* oauth_tokens
* oauth_applications
* oauth_access_tokens
* oauth_access_grants


# API's do OpenStreetMaps

O OpenStreetMap oferece várias APIs que permitem acessar e contribuir com os dados do mapa de diferentes maneiras. Aqui estão os principais tipos de APIs fornecidos pelo OpenStreetMap:

1. API de Dados (RESTful):
  + Esta é a API principal que permite acessar os dados brutos do mapa do OpenStreetMap, como ruas, estradas, edifícios, pontos de interesse, etc.
  + É uma API RESTful que fornece endpoints para recuperar, criar, atualizar e excluir elementos do mapa, bem como para executar consultas de pesquisa e recuperação de dados.
  + Os dados são geralmente retornados em formato XML ou JSON.
  + Exemplo de URL: https://api.openstreetmap.org/api/0.6/map

2. API Nominatim:
  + Esta API é usada para geocodificação/reversão geográfica, ou seja, converter endereços em coordenadas geográficas (latitude e longitude) e vice-versa.
  + Também pode ser usada para pesquisar locais e obter informações sobre lugares específicos.
  + Exemplo de URL: https://nominatim.openstreetmap.org/search

3. API Overpass:
  + Esta API oferece uma interface mais avançada para consultar dados do OpenStreetMap.
  + É especialmente útil para consultas complexas que envolvem filtragem, agrupamento e processamento de dados geoespaciais.
  + Os resultados podem ser retornados em formatos como XML, JSON ou GeoJSON.
  + Exemplo de URL: https://overpass-api.de/api/interpreter

4. API de Estilos:
  + Esta API permite criar e personalizar estilos de renderização para os dados do OpenStreetMap.
  + Os estilos definem como os elementos do mapa são exibidos visualmente em mapas interativos ou estáticos.
  + Exemplo de URL: https://openstreetmap.org/styles

## API de Dados (RESTful)

```{r RESTful}
library(httr)

# Definir as coordenadas de latitude e longitude da área desejada
min_lat <- -23.60
max_lat <- -23.55
min_lon <- -46.70
max_lon <- -46.65

# Montar a URL da API com os parâmetros necessários
url <- paste0("https://api.openstreetmap.org/api/0.6/map?bbox=", min_lon, ",", min_lat, ",", max_lon, ",", max_lat)

# Fazer a solicitação GET para a API
resposta <- GET(url)

# Verificar se a solicitação foi bem-sucedida
# stop_for_status(resposta)

# Extrair o conteúdo da resposta
conteudo <- content(resposta, "text")

# Exibir os dados brutos do mapa
print(conteudo)
```

## API Nominatim

```{r Nominatim}
library(httr)
library(jsonlite)

# Definir as coordenadas de latitude e longitude do ponto de interesse
latitude <- -23.55052  # Exemplo: São Paulo, Brasil
longitude <- -46.633308

# Montar a URL da API com os parâmetros necessários
url <- paste0("https://nominatim.openstreetmap.org/reverse?lat=", latitude, "&lon=", longitude, "&format=json")

# Fazer a solicitação GET para a API
resposta <- GET(url)

# Verificar se a solicitação foi bem-sucedida
stop_for_status(resposta)

# Extrair o conteúdo da resposta
conteudo <- content(resposta, "text", encoding = "UTF-8")

# Converter o conteúdo JSON em um data frame
nominatim_eg <- fromJSON(conteudo)

# Visualizar os dados
str(nominatim_eg)
```

## API Overpass

```{r Overpass}
library(httr)
library(jsonlite)

# Definir a consulta Overpass
consulta_overpass <- '[out:json];(node(around:1000,-23.55052,-46.633308)["amenity"];);out;'

# Codificar a consulta para que seja usada corretamente na URL
consulta_codificada <- URLencode(consulta_overpass)

# Montar a URL da API Overpass
url <- paste0("https://overpass-api.de/api/interpreter?data=", consulta_codificada)

# Fazer a solicitação GET para a API
resposta <- GET(url)

# Verificar se a solicitação foi bem-sucedida
stop_for_status(resposta)

# Extrair o conteúdo da resposta
conteudo <- content(resposta, "text", encoding = "UTF-8")

# Converter o conteúdo JSON em um data frame
overpass_eg <- fromJSON(conteudo)

# Visualizar os dados
str(overpass_eg)
```

## API de Estilos

```{r Estilos}
library(httr)

# Definir o nome do estilo desejado
nome_do_estilo <- "mapnik"  # Mapnik é um estilo de renderização padrão do OpenStreetMap

# Montar a URL da API de Estilos
url <- paste0("https://openstreetmap.org/styles/", nome_do_estilo, "/style.json")

# Fazer a solicitação GET para a API
resposta <- GET(url)

# Verificar se a solicitação foi bem-sucedida
# stop_for_status()

# Extrair o conteúdo da resposta (o estilo de renderização)
estilos_eg <- content(resposta, "text", encoding = "UTF-8")

# Exibir o conteúdo (o estilo de renderização)
str(estilos_eg)

```

# Uso de caso para API RESTful

Começarei recolhendo as informações do usuario.

```{r}
library(httr)
library(jsonlite)

# Defina o UID do usuário do OpenStreetMap que você deseja consultar
uid_usuario <- 21160844

# Faça a solicitação à API de Edições para obter o histórico de edições do usuário pelo UID
url <- paste0("https://api.openstreetmap.org/api/0.6/changesets?user=", uid_usuario)
resposta <- GET(url)

# Verifique se a solicitação foi bem-sucedida
stop_for_status(resposta)

# Extrair o conteúdo da resposta (JSON)
conteudo <- content(resposta, "text", encoding = "UTF-8")

# Analisar o JSON
dados_json <- fromJSON(conteudo)

# Extrair os IDs dos changesets do JSON
ids_changesets <- dados_json$changeset$id

# Exibir os IDs dos changesets
print(ids_changesets)

```
Convertendo o arquivo JSON em CSV

```{r JSON to CSV}
dados_df <- as.data.frame(dados_json)

str(dados_df)
```

Agora irei puxar os valores fornecidos quando fizermos uma requisição para cada valor da coluna changesets.id


```{r loucura pura}
library(httr)
library(dplyr)

# Define o ID do changeset e do usuário que você deseja pesquisar
changeset_id <- 149052433
user_id <- 21160844

# Constrói a URL para a consulta
url <- paste0("https://api.openstreetmap.org/api/0.6/changeset/", changeset_id, "?user=", user_id)

# Faz a solicitação GET para obter os detalhes do changeset específico do usuário
response <- GET(url)

# Verifica se a solicitação foi bem-sucedida
if (http_status(response)$status == 200) {
  # Extrai o conteúdo da resposta
  content <- content(response, "text", encoding = "UTF-8")
  # Processa o conteúdo conforme necessário
  # Por exemplo, você pode analisar o XML ou JSON e extrair as informações relevantes
} else {
  warning("Falha ao buscar o changeset ", changeset_id)
}

```

Transformando os dados JSON em uma tabela

```{r mais loucura}
changeset_id_df <- as.data.frame(dados_jdad)

str(changeset_id_df)
```


# Uso de caso da Overpass API

```{r}
library(httr)
library(jsonlite)

# Defina o ID do changeset desejado
changeset_id <- "#149053068"

# Construa a consulta Overpass QL
overpass_query <- paste0('[out:json][timeout:25];',
                         'changeset(', changeset_id, ');',
                         'out;')

# Envie a consulta para a Overpass API
response <- POST("https://overpass-api.de/api/interpreter", body = overpass_query)

# Verifique se a solicitação foi bem-sucedida
stop_for_status(response)

# Analise a resposta JSON
changeset_info <- content(response, "text") %>%
  fromJSON()

# Exiba as informações do changeset
print(changeset_info)
```

```{r}
library(httr)
library(xml2)

# Função para buscar informações do usuário pelo nome de usuário
get_user_info <- function(username) {
  # Construir a consulta Overpass
  query <- paste0("[out:xml];user:", username, ";out;")

  # Codificar a consulta para usar na URL
  query_encoded <- URLencode(query)

  # URL da API Overpass
  url <- paste0("https://overpass-api.de/api/interpreter?data=", query_encoded)

  # Fazer a solicitação HTTP
  response <- GET(url)

  # Verificar se a solicitação foi bem-sucedida
  stop_for_status(response)

  # Extrair o conteúdo da resposta
  content <- content(response, "text", encoding = "UTF-8")

  # Analisar o XML
  xml <- read_xml(content)

  # Extrair informações relevantes
  user_info <- xml_find_all(xml, ".//user")

  return(user_info)
}

# Defina o nome de usuário que você deseja pesquisar
username <- "Mauricio Ed"

# Obter informações do usuário
user_info <- get_user_info(username)

# Exibir informações do usuário
print(user_info)

```

```{r}

```

